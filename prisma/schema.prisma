generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ----------------------------
// USERS
// ----------------------------
model User {
  id               String              @id @default(uuid())
  email            String              @unique
  emailVerified    Boolean             @default(false)
  name             String?
  image            String?
  banned           Boolean?
  banReason        String?
  banExpires       DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  sessions         Session[]
  accounts         Account[]
  workspaces       workspaces[]
  workspaceMembers workspace_members[]
  userMetadata     user_metadata?

  @@map("users")
}

model user_metadata {
  id                String   @id @default(uuid())
  user_id           String   @unique
  timezone          String   @default("UTC")
  locale            String   @default("en-US")
  sms_country_code  String?
  sms_phone_number  String?
  sms_verified      Boolean  @default(false)
  call_country_code String?
  call_phone_number String?
  call_verified     Boolean  @default(false)
  preferences       Json?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_metadata")
}

model Session {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  providerId String
  accountId  String
  password   String?
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}

// ----------------------------
// WORKSPACES
// ----------------------------
model workspaces {
  id             String              @id @default(uuid())
  owner_id       String
  name           String
  created_at     DateTime            @default(now())
  owner          User                @relation(fields: [owner_id], references: [id])
  members        workspace_members[]
  monitors       monitors[]
  alert_channels alert_channels[]
  statusPages    status_pages[]
  alertRules     alert_rules[]
  incidents      incidents[]
}

// ----------------------------
// WORKSPACE MEMBERS
// ----------------------------
model workspace_members {
  id           String     @id @default(uuid())
  workspace_id String
  user_id      String
  role         String
  created_at   DateTime   @default(now())
  workspace    workspaces @relation(fields: [workspace_id], references: [id])
  user         User       @relation(fields: [user_id], references: [id])
}

// ----------------------------
// MONITORS
// ----------------------------
model monitors {
  id                    String    @id @default(uuid())
  workspace_id          String
  name                  String
  url                   String
  type                  String
  interval_seconds      Int       @default(60)
  timeout_ms            Int       @default(5000)
  expected_status       Int
  check_regions         String
  status                String    @default("healthy")
  last_response_time_ms Int?
  tags                  String[]
  last_checked_at       DateTime?
  next_run_at           DateTime
  consecutive_failures  Int       @default(0)
  max_retries           Int       @default(0)
  created_at            DateTime  @default(now())
  updated_at            DateTime  @updatedAt
  is_active             Boolean   @default(true)

  workspace workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  checks       monitor_checks[]
  incidents    incidents[]
  alert_rules  alert_rules[]
  alerts_sent  alerts_sent[]
  status_pages status_pages[]   @relation("StatusPageMonitors")

  @@index([workspace_id])
}

// ----------------------------
// MONITOR CHECKS
// ----------------------------
model monitor_checks {
  id                      String      @id @default(uuid())
  monitor_id              String
  checked_at              DateTime
  status                  String
  response_time_ms        Int?
  http_status             Int?
  success                 Boolean
  error_message           String?
  dns_lookup_ms           Int?
  ssl_handshake_ms        Int?
  connect_ms              Int?
  download_ms             Int?
  response_size_bytes     Int?
  response_headers        Json?
  request_headers         Json?
  response_body           String?
  monitor                 monitors    @relation(fields: [monitor_id], references: [id])
  incident_check          incidents[] @relation("IncidentCheck")
  incident_resolved_check incidents[] @relation("IncidentResolvedCheck")

  @@index([monitor_id, checked_at])
}

// ----------------------------
// INCIDENTS
// ----------------------------
model incidents {
  id                String          @id @default(uuid())
  monitor_id        String
  check_id          String?
  workspace_id      String
  resolved_check_id String?
  started_at        DateTime
  resolved_at       DateTime?
  duration_seconds  Int?
  reason            String?
  created_at        DateTime        @default(now())
  monitor           monitors        @relation(fields: [monitor_id], references: [id])
  check             monitor_checks? @relation("IncidentCheck", fields: [check_id], references: [id])
  workspace         workspaces      @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  resolved_check    monitor_checks? @relation("IncidentResolvedCheck", fields: [resolved_check_id], references: [id])
  alerts            alerts_sent[]
}

// ----------------------------
// ALERT RULES
// ----------------------------
model alert_rules {
  id           String     @id @default(uuid())
  monitor_id   String
  workspace_id String
  alert_type   String
  workspace    workspaces @relation(fields: [workspace_id], references: [id])
  enabled      Boolean
  events       String[]
  created_at   DateTime   @default(now())
  monitor      monitors   @relation(fields: [monitor_id], references: [id])

  @@unique([monitor_id, alert_type])
}

// ----------------------------
// ALERT CHANNELS
// ----------------------------
model alert_channels {
  id           String        @id @default(uuid())
  workspace_id String
  type         String
  destination  String
  created_at   DateTime      @default(now())
  workspace    workspaces    @relation(fields: [workspace_id], references: [id])
  alerts       alerts_sent[]

  @@unique([workspace_id, type, destination])
}

// ----------------------------
// ALERTS SENT
// ----------------------------
model alerts_sent {
  id          String         @id @default(uuid())
  monitor_id  String
  channel_id  String
  incident_id String?
  sent_at     DateTime
  alert_type  String
  message     String?
  monitor     monitors       @relation(fields: [monitor_id], references: [id])
  channel     alert_channels @relation(fields: [channel_id], references: [id])
  incident    incidents?     @relation(fields: [incident_id], references: [id])
}

// -------------------------------------
// STATUS PAGES
// -------------------------------------
model status_pages {
  id            String     @id @default(uuid())
  workspace_id  String
  name          String
  custom_domain String?    @unique
  access_level  String
  status        String
  updated_at    DateTime   @updatedAt
  created_at    DateTime   @default(now())
  workspace     workspaces @relation(fields: [workspace_id], references: [id])
  monitors      monitors[] @relation("StatusPageMonitors")
}
