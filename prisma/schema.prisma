generator client {
  provider = "prisma-client"
  output   = "./generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ----------------------------
// USERS
// ----------------------------
model User {
  id               String              @id @default(uuid())
  email            String              @unique
  emailVerified    Boolean             @default(false)
  name             String?
  image            String?
  banned           Boolean?
  banReason        String?
  banExpires       DateTime?
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  sessions         Session[]
  accounts         Account[]
  workspaces       workspaces[]
  workspaceMembers workspace_members[]
  userMetadata     user_metadata?
  incidentComments incident_comments[]
  activityLogs     activity_logs[]

  @@map("users")
}

model user_metadata {
  id                String   @id @default(uuid())
  user_id           String   @unique
  timezone          String   @default("UTC")
  locale            String   @default("en-US")
  sms_country_code  String?
  sms_phone_number  String?
  sms_verified      Boolean  @default(false)
  call_country_code String?
  call_phone_number String?
  call_verified     Boolean  @default(false)
  preferences       Json?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  user User @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@map("user_metadata")
}

model Session {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  expiresAt DateTime
  token     String   @unique
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model Account {
  id         String   @id @default(uuid())
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  providerId String
  accountId  String
  password   String?
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([providerId, accountId])
  @@map("accounts")
}

model Verification {
  id         String   @id @default(uuid())
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("verifications")
}

// ----------------------------
// WORKSPACES
// ----------------------------
model workspaces {
  id                   String              @id @default(uuid())
  owner_id             String
  name                 String
  current_plan_type    String              @default("free") // 'free', 'solo', 'team', 'enterprise'
  razorpay_customer_id String?             @unique
  billing_details      Json?
  created_at           DateTime            @default(now())
  updated_at           DateTime            @updatedAt
  owner                User                @relation(fields: [owner_id], references: [id])
  members              workspace_members[]
  monitors             monitors[]
  alert_channels       alert_channels[]
  statusPages          status_pages[]
  alertRules           alert_rules[]
  incidents            incidents[]
  subscription         subscriptions?
  tags                 tags[]
  incidentComments     incident_comments[]
  activityLogs         activity_logs[]
  maintenance          maintenance?
}

// ----------------------------
// WORKSPACE MEMBERS
// ----------------------------
model workspace_members {
  id           String     @id @default(uuid())
  workspace_id String
  user_id      String?
  role         String
  metadata     Json?
  created_at   DateTime   @default(now())
  updated_at   DateTime   @updatedAt
  is_active    Boolean    @default(true)
  workspace    workspaces @relation(fields: [workspace_id], references: [id])
  user         User?      @relation(fields: [user_id], references: [id])
}

// ----------------------------
// MONITORS
// ----------------------------
model monitors {
  id                         String    @id @default(uuid())
  workspace_id               String
  name                       String
  group                      String
  url                        String?
  type                       String
  interval_seconds           Int       @default(60)
  timeout_ms                 Int       @default(5000)
  expected_status            String[]
  check_regions              String
  status                     String    @default("healthy")
  last_response_time_ms      Int?
  last_checked_at            DateTime?
  grace_period               Int?
  next_run_at                DateTime
  consecutive_failures       Int       @default(0)
  records                    Json?
  max_retries                Int       @default(0)
  created_at                 DateTime  @default(now())
  updated_at                 DateTime  @updatedAt
  is_active                  Boolean   @default(true)
  keyword                    String?
  keyword_match_type         String?
  port                       Int?
  check_ssl_errors           Boolean   @default(false)
  ssl_expiry_reminders       Boolean   @default(false)
  domain_expiry_reminders    Boolean   @default(false)
  follow_redirects           Boolean?  @default(true)
  slow_response_alert        Boolean?  @default(false)
  slow_response_threshold_ms Int?      @default(1000)
  auth_type                  String?   @default("none")
  auth_username              String?
  auth_password              String?
  http_method                String?   @default("HEAD")
  request_body               String?
  send_json                  Boolean?  @default(false)
  headers                    Json?

  workspace workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  checks        monitor_checks[]
  incidents     incidents[]
  alerts_sent   alerts_sent[]
  status_pages  status_pages[]           @relation("StatusPageMonitors")
  tags          monitor_tags[]
  alertChannels alert_channel_monitors[]

  @@index([workspace_id])
}

model monitor_tags {
  monitor_id String
  tag_id     String

  monitor monitors @relation(fields: [monitor_id], references: [id], onDelete: Cascade)
  tag     tags     @relation(fields: [tag_id], references: [id], onDelete: Cascade)

  @@id([monitor_id, tag_id])
}

model tags {
  id           String @id @default(uuid())
  name         String
  workspace_id String

  workspace workspaces     @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  monitors  monitor_tags[]

  @@unique([workspace_id, name])
}

// ----------------------------
// MONITOR CHECKS
// ----------------------------
model monitor_checks {
  id                      String      @id @default(uuid())
  monitor_id              String
  checked_at              DateTime
  status                  String
  response_time_ms        Int?
  http_status             Int?
  success                 Boolean
  error_message           String?
  dns_lookup_ms           Int?
  ssl_handshake_ms        Int?
  connect_ms              Int?
  download_ms             Int?
  response_size_bytes     Int?
  response_headers        Json?
  request_headers         Json?
  response_body           String?
  created_at              DateTime    @default(now())
  updated_at              DateTime    @updatedAt
  monitor                 monitors    @relation(fields: [monitor_id], references: [id])
  incident_check          incidents[] @relation("IncidentCheck")
  incident_resolved_check incidents[] @relation("IncidentResolvedCheck")

  @@index([monitor_id, checked_at])
}

// ----------------------------
// INCIDENTS
// ----------------------------
model incidents {
  id                String              @id @default(uuid())
  monitor_id        String
  check_id          String?
  workspace_id      String
  resolved_check_id String?
  started_at        DateTime
  resolved_at       DateTime?
  duration_seconds  Int?
  reason            String?
  created_at        DateTime            @default(now())
  updated_at        DateTime            @updatedAt
  monitor           monitors            @relation(fields: [monitor_id], references: [id])
  check             monitor_checks?     @relation("IncidentCheck", fields: [check_id], references: [id])
  workspace         workspaces          @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  resolved_check    monitor_checks?     @relation("IncidentResolvedCheck", fields: [resolved_check_id], references: [id])
  alerts            alerts_sent[]
  incidentComments  incident_comments[]
}

// ----------------------------
// ALERT RULES
// ----------------------------
model alert_rules {
  id           String     @id @default(uuid())
  workspace_id String
  alert_type   String
  workspace    workspaces @relation(fields: [workspace_id], references: [id])
  enabled      Boolean
  events       String[]
  created_at   DateTime   @default(now())
  updated_at   DateTime   @updatedAt

  @@unique([workspace_id, alert_type])
}

// ----------------------------
// ALERT CHANNELS
// ----------------------------
model alert_channels {
  id           String                   @id @default(uuid())
  workspace_id String
  type         String
  destination  String
  created_at   DateTime                 @default(now())
  updated_at   DateTime                 @updatedAt
  workspace    workspaces               @relation(fields: [workspace_id], references: [id])
  alerts       alerts_sent[]
  monitors     alert_channel_monitors[]

  @@unique([workspace_id, type, destination])
}

model alert_channel_monitors {
  channel_id String
  monitor_id String

  channel alert_channels @relation(fields: [channel_id], references: [id], onDelete: Cascade)
  monitor monitors       @relation(fields: [monitor_id], references: [id], onDelete: Cascade)

  @@id([channel_id, monitor_id])
  @@index([monitor_id])
}

// ----------------------------
// ALERTS SENT
// ----------------------------
model alerts_sent {
  id          String         @id @default(uuid())
  monitor_id  String
  channel_id  String
  incident_id String?
  sent_at     DateTime
  created_at  DateTime       @default(now())
  updated_at  DateTime       @updatedAt
  alert_type  String
  message     String?
  monitor     monitors       @relation(fields: [monitor_id], references: [id])
  channel     alert_channels @relation(fields: [channel_id], references: [id])
  incident    incidents?     @relation(fields: [incident_id], references: [id])
}

// -------------------------------------
// STATUS PAGES
// -------------------------------------
model status_pages {
  id            String     @id @default(uuid())
  workspace_id  String
  name          String
  custom_domain String?    @unique
  access_level  String
  status        String
  configs       Json?
  updated_at    DateTime   @updatedAt
  created_at    DateTime   @default(now())
  workspace     workspaces @relation(fields: [workspace_id], references: [id])
  monitors      monitors[] @relation("StatusPageMonitors")
}

model incident_comments {
  id                     String   @id @default(uuid())
  incident_id            String
  user_id                String
  workspace_id           String
  content                String
  publish_on_status_page Boolean
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  incident  incidents  @relation(fields: [incident_id], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  workspace workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)

  @@index([incident_id])
  @@index([workspace_id])
  @@map("incident_comments")
}

model activity_logs {
  id            String   @id @default(uuid())
  workspace_id  String
  actor_user_id String?
  entity_type   String
  entity_id     String?
  action        String
  message       String?
  metadata      Json?
  created_at    DateTime @default(now())

  workspace workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  actor     User?      @relation(fields: [actor_user_id], references: [id], onDelete: SetNull)

  @@index([workspace_id])
  @@index([entity_type, entity_id])
  @@index([action])
  @@map("activity_logs")
}

// ----------------------------
// SUBSCRIPTIONS
// ----------------------------
model subscription_plans {
  id               String   @id @default(uuid())
  razorpay_plan_id String?  @unique
  name             String
  plan_type        String
  billing_cycle    String
  amount           Decimal
  addons           Json?
  currency         String
  interval_count   Int
  features         Json
  created_at       DateTime @default(now())
  updated_at       DateTime @updatedAt

  subscriptions subscriptions[]

  @@unique([plan_type, billing_cycle])
  @@map("subscription_plans")
}

model subscriptions {
  id                       String                      @id @default(uuid())
  workspace_id             String                      @unique
  plan_id                  String
  razorpay_subscription_id String                      @unique
  razorpay_customer_id     String
  status                   String
  is_current               Boolean                     @default(true)
  current_period_start     DateTime
  current_period_end       DateTime
  cancel_at_period_end     Boolean                     @default(false)
  cancelled_at             DateTime?
  trial_end                DateTime?
  base_price_snapshot      Decimal
  currency_snapshot        String                      @default("INR")
  created_at               DateTime                    @default(now())
  updated_at               DateTime                    @updatedAt
  workspace                workspaces                  @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
  plan                     subscription_plans          @relation(fields: [plan_id], references: [id])
  transactions             subscription_transactions[]
  addons                   Json?
  addons_snapshot          Json?

  @@index([workspace_id])
  @@index([status])
  @@index([is_current])
  @@map("subscriptions")
}

model subscription_transactions {
  id                  String   @id @default(uuid())
  subscription_id     String
  razorpay_payment_id String?  @unique
  razorpay_order_id   String?
  amount              Decimal
  currency            String   @default("INR")
  status              String // 'pending', 'success', 'failed', 'refunded'
  payment_method      String
  failure_reason      String?
  metadata            Json
  created_at          DateTime @default(now())
  updated_at          DateTime @updatedAt

  subscription subscriptions @relation(fields: [subscription_id], references: [id], onDelete: Cascade)

  @@index([subscription_id])
  @@index([status])
  @@map("subscription_transactions")
}

model maintenance {
  id           String   @id @default(uuid())
  workspace_id String   @unique
  project_ids  String[]
  client_ids   String[]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  workspace workspaces @relation(fields: [workspace_id], references: [id], onDelete: Cascade)
}
